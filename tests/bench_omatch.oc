#include <time.h>
#include <stdio.h>
#include <obliv.oh>
#include <stdbool.h>
#include <stdlib.h>
#include <time.h>

#include "util.h"
#include "omatch.oh"
#include "uint128.h"
#include "test_generic.h"

#define SAMPLES 30

static const char TESTNAME[] = "omatch_benchmark";

char* testName() {
	return TESTNAME;
}

void shuffle(uint32_t *array, size_t n) {
    if (n > 1) {
        size_t i;
        for (i = 0; i < n - 1; i++) 
        {
          size_t j = i + rand() / (RAND_MAX / (n - i) + 1);
          int t = array[j];
          array[j] = array[i];
          array[i] = t;
        }
    }
}

int pcts[] = {4,8,16,32,64,128,256,512,1024};
int pn = sizeof(pcts)/sizeof(pcts[0]);

void testMain(void*varg) {

	fprintf(stdout, "==========\nGALE SHAPLEY (pair count, sample 1, sample 2, ... sample n)\n----------\n");
	fflush(stdout);

	{

		for (int ii = 0; ii < pn; ii++) {
			int pairs = pcts[ii];
			uint128_t * tally = uint128_new();

			fprintf(stdout, "%d", pairs);
			fflush(stdout);

			uint32_t * perm = malloc(pairs * sizeof(uint32_t));
			for (int kk = 0; kk < pairs; kk++) {
				perm[kk] = kk;
			}

			obliv uint32_t * mPrefs = calloc(pairs * pairs, sizeof(obliv uint32_t));
			obliv uint32_t * wPrefs = calloc(pairs * pairs, sizeof(obliv uint32_t));
			obliv uint32_t * output = calloc(pairs, sizeof(obliv uint32_t));

			int samples = pairs < 128 ? SAMPLES : (pairs < 1024 ? 3 : 1);

			for (int kk = 0; kk < samples; kk++) {
				for (int ll = 0; ll < pairs; ll++) {
					shuffle(perm, pairs);
					for (int jj = 0; jj < pairs; jj++) {
						mPrefs[ll * pairs + jj] = feedOblivInt(perm[jj], 0);
					}
					for (int jj = 0; jj < pairs; jj++) {
						wPrefs[ll * pairs + jj] = feedOblivInt(perm[jj], 1);
					}
				}

				uint128_t * startTime = uint128_current_timestamp();
				ogale_shapley(output, mPrefs, wPrefs, pairs);
				uint128_t * endTime = uint128_current_timestamp();


				uint128_t * runtime = uint128_subtract(endTime, startTime);
				free(endTime); free(startTime);
				fprintf(stdout, ",");
				print_uint128(stdout, runtime);
				fflush(stdout);
				uint128_t * newtally = uint128_add(tally, runtime);
				free(runtime);
				free(tally);
				tally = newtally;

				
			}

			free(perm);
			free(mPrefs);
			free(wPrefs);
			free(output);

			fprintf(stdout, "\n");
			fflush(stdout);
			fprintf(stderr, "GALE SHAPLEY (pairs:%d): ", pairs);
			uint128_t * longsamples = uint128_from(samples);
			uint128_t * avgtime = uint128_divide(tally, longsamples);
			print_uint128(stderr, avgtime);
			free(avgtime);
			free(longsamples);
			free(tally);
			fprintf(stderr, " microseconds avg\n");
		}

	}

}
